<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>حاسبة حصّة أكل القطط</title>
  <style>
    :root{
      --bg:#0b1120; --card:#0b1220; --ring:#334155; --text:#e5e7eb; --muted:#94a3b8;
      --hx:#a7f3d0; --accent:#22c55e; --accent2:#10b981; --line:#1f2937; --result-bg:#0a0f1a; --table-head:#0b1325;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f7fb; --card:#ffffff; --ring:#d1d5db; --text:#0f172a; --muted:#475569;
        --hx:#0ea5e9; --accent:#16a34a; --accent2:#10b981; --line:#e5e7eb; --result-bg:#f8fafc; --table-head:#f1f5f9;
      }
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:"Cairo", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      line-height:1.6;
    }
    header{padding:10px 12px; text-align:center; position:sticky; top:0; z-index:5; background:var(--bg); border-bottom:1px solid var(--line)}
    h1{margin:0; font-size:clamp(16px,3.2vw,24px); font-weight:800; letter-spacing:.2px;
      background:linear-gradient(90deg,var(--text),var(--hx) 60%,var(--text)); -webkit-background-clip:text; background-clip:text; color:transparent}
    .topbar{display:flex; justify-content:center; align-items:center; gap:8px; margin-top:6px}
    .lang-toggle{display:inline-flex; gap:4px; align-items:center; border:1px solid var(--line); border-radius:999px; padding:3px 6px; font-size:11px; background:var(--card); direction:ltr}
    .lang-toggle button{border:none; background:transparent; padding:3px 6px; border-radius:999px; cursor:pointer; font-weight:800; color:var(--muted)}
    .lang-toggle button.active{ background:var(--line); color:var(--text) }

    main{ width:min(960px,96%); margin:8px auto 10px; }

    /* Serving bar above cards */
    
    .serving-bar label{font-weight:800; font-size:13px; white-space:nowrap}
    .serving-bar input{
      flex:1; padding:8px 10px; border-radius:10px; border:1px solid var(--ring); background:transparent; font-size:14px; color:var(--text);
    }

    .grid{display:grid; grid-template-columns:1fr 1fr; gap:8px}
    .card{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:10px; box-shadow:0 6px 16px rgba(0,0,0,.06)}
    .section-title{font-size:12px; font-weight:800; color:#065f46; background:#d1fae5; display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; margin-bottom:6px; border:1px solid #a7f3d0}
    @media (prefers-color-scheme: dark){ .section-title{ color:#bbf7d0; background:#052e1a; border:1px solid #064e3b } }
    label{display:block; font-weight:700; margin-bottom:4px; font-size:12px}
    input{width:100%; padding:8px 10px; border-radius:10px; background:transparent; border:1px solid var(--ring); outline:none; font-size:14px; color:var(--text)}
    input::placeholder{color:#94a3b8}
    input:focus{border-color:var(--accent); box-shadow:0 0 0 3px #22c55e22}
    .two{display:grid; grid-template-columns:1fr; gap:6px}

    table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:10px; margin-top:4px}
    thead th{background:var(--table-head); color:var(--text); text-align:right; padding:8px; font-size:12px; border-bottom:1px solid var(--line); white-space:nowrap}
    tbody td{padding:8px; border-bottom:1px dashed var(--line); font-size:13px}
    tbody tr:last-child td{border-bottom:none}

    .actions{display:flex; justify-content:center; gap:10px; margin-top:12px}
    .btn{padding:10px 14px; border-radius:12px; border:1px solid var(--line); background:var(--table-head); color:var(--text); font-weight:800; cursor:pointer; font-size:14px}
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2)); color:white; border:none}

    footer{padding:6px 0 8px; text-align:center; color:#64748b; font-size:12px; margin-top:8px}
  
    .remain-pill{min-width:64px; padding:6px 10px; border-radius:999px; font-weight:800; text-align:center;
      background:#052e1a; color:#bbf7d0; border:1px solid #064e3b}
    .remain-pill.bad{background:#3b0a0a; color:#fecaca; border-color:#7f1d1d}
    .tooltip{display:none; position:absolute; inset-block-start:100%; inset-inline-start:0; transform:translateY(6px);
      font-size:12px; color:#fecaca; background:#3b0a0a; border:1px solid #7f1d1d; padding:6px 8px; border-radius:8px; z-index:10}
    .tooltip.show{display:block}
    .invalid{border-color:#ef4444 !important; box-shadow:0 0 0 3px #ef444422 !important}
    .serving-bar{position:relative}
    .unit{opacity:.8; font-size:12px; margin-inline-start:6px}

  

  
/* Language-aware serving bar layout */
.serving-bar{position:relative; display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:8px}
/* Default (English/LTR): [pill][input][label] */
.serving-bar #remain{grid-column:1}
.serving-bar input#servingTop{grid-column:2}
.serving-bar label[for="servingTop"]{grid-column:3; white-space:nowrap}
/* Arabic (RTL): [label][input][pill] */
html[lang="ar"] .serving-bar label[for="servingTop"]{grid-column:1; text-align:right}
html[lang="ar"] .serving-bar input#servingTop{grid-column:2}
html[lang="ar"] .serving-bar #remain{grid-column:3}

  
/* Force single-row layout & tidy label */
.serving-bar{grid-auto-flow:column; grid-auto-columns:max-content}
.serving-bar label[for="servingTop"]{margin:0; align-self:center; display:block}
.serving-bar input#servingTop{width:100%}

  
.alert-area{margin-top:8px; padding:10px 12px; border-radius:12px; font-size:14px; font-weight:700;
  background:#3b0a0a; color:#fecaca; border:1px solid #7f1d1d}
.input.invalid, input.invalid{border-color:#ef4444 !important; box-shadow:0 0 0 3px #ef444422 !important; background:#7f1d1d22}

  
/* lang-aware serving bar */
.serving-bar{position:relative; display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:8px}
/* EN (default LTR) */
html[lang="en"] .serving-bar #remain{grid-column:1}
html[lang="en"] .serving-bar input#servingTop{grid-column:2}
html[lang="en"] .serving-bar label[for="servingTop"]{grid-column:3; white-space:nowrap}
/* AR (RTL) */
html[lang="ar"] .serving-bar label[for="servingTop"]{grid-column:1; white-space:nowrap; text-align:right}
html[lang="ar"] .serving-bar input#servingTop{grid-column:2}
html[lang="ar"] .serving-bar #remain{grid-column:3}
/* pill write-order */
.remain-pill{direction:ltr; unicode-bidi:plaintext}
/* alert area visual */
.alert-area{margin-top:8px; padding:10px 12px; border-radius:12px; font-size:14px; font-weight:700;
  background:#3b0a0a; color:#fecaca; border:1px solid #7f1d1d}
/* invalid inputs */
input.invalid{border-color:#ef4444 !important; box-shadow:0 0 0 3px #ef444422 !important; background:#7f1d1d22}

  </style>
</head>
<body>
  <header>
    <h1 data-i18n="title">حاسبة حصّة أكل القطط</h1>
    <div class="topbar">
      <div></div>
      <div class="lang-toggle" role="tablist" aria-label="Language"><button id="btn-en" data-lang="en" role="tab" aria-selected="false">English</button>
        <button id="btn-ar" class="active" data-lang="ar" role="tab" aria-selected="true">العربية</button>
      </div>
    </div>
  </header>

  <main>
    <!-- Serving size bar -->
    <div class="serving-bar"><div id="remain" class="remain-pill">100%</div><input id="servingTop" inputmode="decimal" placeholder="50"><label for="servingTop" data-i18n="serving_label">حجم الحصّة (غ)</label><div id="remainTip" class="tooltip" data-i18n="remain_tip">مجموع النِّسَب لازم يكون أقل من 100%</div></div>
    <div id="alertArea" class="alert-area" role="alert" aria-live="polite" style="display:none"></div>

    <div class="grid">
      <!-- Right: inputs (percentages only) -->
      <section class="card">
        <div class="section-title" data-i18n="inputs">⚙️ إدخال البيانات</div>
        <div class="two">
          <div>
            <label for="protein" data-i18n="protein">بروتين %</label>
            <input id="protein" inputmode="decimal" placeholder="10">
          </div>
          <div>
            <label for="fat" data-i18n="fat">دهون %</label>
            <input id="fat" inputmode="decimal" placeholder="5">
          </div>
        </div>
        <div class="two" style="margin-top:6px">
          <div>
            <label for="fiber" data-i18n="fiber">ألياف %</label>
            <input id="fiber" inputmode="decimal" placeholder="1.5">
          </div>
          <div>
            <label for="moisture" data-i18n="moisture">رطوبة %</label>
            <input id="moisture" inputmode="decimal" placeholder="78">
          </div>
        </div>
        <div class="two" style="margin-top:6px">
          <div>
            <label for="ash" data-i18n="ash">رماد %</label>
            <input id="ash" inputmode="decimal" placeholder="2.5">
          </div>
        </div>
      </section>

      <!-- Left: results table -->
      <section class="card">
        <div class="section-title" data-i18n="results">📊 النتائج</div>
        <table>
          <thead>
            <tr>
              <th data-i18n="col_item">&lrm;</th>
              <th data-i18n="col_serving">لكل حصة</th>
            </tr>
          </thead>
          <tbody>
            <tr><td data-i18n="calories">السعرات</td><td id="calServing">—</td></tr>
            <tr><td data-i18n="p">البروتين</td><td id="gProtein">—</td></tr>
            <tr><td data-i18n="nfe">الكارب</td><td id="gNfe">—</td></tr>
            <tr><td data-i18n="f">الدهون</td><td id="gFat">—</td></tr>
            <tr><td data-i18n="fi">الألياف</td><td id="gFiber">—</td></tr>
            <tr><td data-i18n="m">الرطوبة</td><td id="gMoisture">—</td></tr>
            <tr><td data-i18n="a">الرماد</td><td id="gAsh">—</td></tr>
          </tbody>
        </table>
      </section>
    </div>

    <div class="actions" id="actionsContainer" dir="inherit">
      <button class="btn primary" id="calc" data-i18n="calc">احسب</button>
      <button class="btn" id="reset" data-i18n="reset">إعادة ضبط</button>
    </div>

    <footer>
      <span id="rights">© 2025 albraichy — جميع الحقوق محفوظة.</span>
    </footer>
  </main>

  <script>
    const STR = {
      ar: {
        title:"حاسبة حصّة أكل القطط", inputs:"⚙️ إدخال البيانات",
        serving_label:"حجم الحصّة (غ)",
        protein:"بروتين %", fat:"دهون %", fiber:"ألياف %", moisture:"رطوبة %", ash:"رماد %",
        calc:"احسب", reset:"إعادة ضبط", results:"📊 النتائج",
        col_item:"", col_serving:"لكل حصة",
        calories:"السعرات",
        p:"البروتين", f:"الدهون", fi:"الألياف", m:"الرطوبة", a:"الرماد", nfe:"الكارب",
        rights:"© 2025 albraichy — جميع الحقوق محفوظة."
      },
      en: {
        title:"Cat Food Serving Calculator", inputs:"⚙️ Inputs",
        serving_label:"Serving size (g)",
        protein:"Protein %", fat:"Fat %", fiber:"Fiber %", moisture:"Moisture %", ash:"Ash %",
        calc:"Calculate", reset:"Reset", results:"📊 Results",
        col_item:"", col_serving:"per serving",
        calories:"Calories",
        p:"Protein", f:"Fat", fi:"Fiber", m:"Moisture", a:"Ash", nfe:"Carb",
        rights:"© 2025 albraichy — All rights reserved."
      }
    };
    function setLang(lang){
  const d = STR[lang];
  document.documentElement.lang = (lang==='ar' ? 'ar' : 'en');
  document.documentElement.dir  = (lang==='ar' ? 'rtl' : 'ltr');
  document.getElementById('btn-ar').classList.toggle('active', lang==='ar');
  document.getElementById('btn-en').classList.toggle('active', lang==='en');
  document.querySelectorAll('[data-i18n]').forEach(el=>{ const k=el.getAttribute('data-i18n'); if(d[k]) el.textContent = d[k]; });
  document.getElementById('rights').textContent = d.rights;
  try{ localStorage.setItem('meow_lang', lang); }catch(e){}
}

    const ATW = { protein:3.5, fat:8.5, carb:3.5 };

    function normalizeDigits(str){
      if(!str) return '';
      const map = {'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9',
                   '۰':'0','۱':'1','۲':'2','۳':'3','۴':'4','۵':'5','۶':'6','۷':'7','۸':'8','۹':'9'};
      return str.replace(/[٠-٩۰-۹]/g, d => map[d])
                .replace(/\u066B/g, '.')  // Arabic decimal separator (٫)
                .replace(/\u066C/g, '')   // Arabic thousands separator (٬)
                .replace(/,/g, '.')       // comma as decimal
                .trim();
    }

    function parseNumEl(el){ const v = normalizeDigits(el.value); const n = parseFloat(v); return isFinite(n)?n:0; }
    function nfePercent(p,f,fi,m,a){ return 100 - ((p||0)+(f||0)+(fi||0)+(m||0)+(a||0)); }
    function kcalPer100g(p,f,fi,m,a){ const nfe = nfePercent(p,f,fi,m,a); const kcal = (p*ATW.protein)+(nfe*ATW.carb)+(f*ATW.fat); return {kcal100:kcal, nfe}; }
    function byPct(s, pct){ return s*(pct/100); }
    function fmt(x, d=1){ return isFinite(x)?Number(x).toFixed(d):'—'; }

    function calc(){
      const s = parseNumEl(document.getElementById('servingTop'));
      const p = parseNumEl(document.getElementById('protein'));
      const f = parseNumEl(document.getElementById('fat'));
      const fi = parseNumEl(document.getElementById('fiber'));
      const m = parseNumEl(document.getElementById('moisture'));
      const a = parseNumEl(document.getElementById('ash'));

      if(!(s>0)){ alert(document.documentElement.lang==='ar' ? 'حجم الحصّة لازم يكون رقم صحيح (>0).' : 'Serving size must be > 0.'); return; }

      const {kcal100,nfe} = kcalPer100g(p,f,fi,m,a);
      const ks = kcal100 * (s/100);

      // per serving column (grams)
      gProtein.textContent=fmt(byPct(s,p));
      gNfe.textContent=fmt(byPct(s,nfe));
      gFat.textContent=fmt(byPct(s,f));
      gFiber.textContent=fmt(byPct(s,fi));
      gMoisture.textContent=fmt(byPct(s,m));
      gAsh.textContent=fmt(byPct(s,a));

      // calories row
      calServing.textContent = fmt(ks);
    }

    function resetAll(){
      ['servingTop','protein','fat','fiber','moisture','ash'].forEach(id=>document.getElementById(id).value='');
      ['gProtein','gNfe','gFat','gFiber','gMoisture','gAsh','calServing'].forEach(id=>window[id].textContent='—');
    }

    document.getElementById('calc').addEventListener('click', calc);
    document.getElementById('reset').addEventListener('click', resetAll);
    document.getElementById('btn-ar').addEventListener('click', ()=>setLang('ar'));
    document.getElementById('btn-en').addEventListener('click', ()=>setLang('en'));
    (()=>{let lang=(()=>{try{return localStorage.getItem('meow_lang')||''}catch(e){return ''}})(); if(!lang){const pref=(navigator.language||navigator.userLanguage||'en').toLowerCase(); lang = pref.startsWith('ar')?'ar':'en';} setLang(lang);})();
  
// === overrides (non-destructive) ===
(function(){
  const $ = s=>document.querySelector(s);
  function fmt(x){return isFinite(x)?Number(x).toFixed(1):'—'}
  function byPct(s,p){return s*(p/100)}
  function remPct(p,f,fi,m,a){return 100-((p||0)+(f||0)+(fi||0)+(m||0)+(a||0))}

  const sEl = document.getElementById('servingTop');
  const fields = ['protein','fat','fiber','moisture','ash'].map(id=>document.getElementById(id));

  function markInvalid(el){el.classList.add('invalid'); el.addEventListener('focus',()=>el.classList.remove('invalid'),{once:true});}

  window.updateRemaining = function(){
    const vals = Object.fromEntries(fields.map(el=>[el.id, parseNumEl(el)]));
    const rem = remPct(vals.protein, vals.fat, vals.fiber, vals.moisture, vals.ash);
    const pill = document.getElementById('remain');
    const tip  = document.getElementById('remainTip');
    if(pill){ pill.textContent=(isFinite(rem)?Math.max(rem,-999):100).toFixed(0)+'%'; pill.classList.toggle('bad', rem<=0); }
    if(tip){ tip.classList.toggle('show', rem<=0); }
  };

  window.calc = function(){
    let ok=true;
    const s = parseNumEl(sEl);
    if(!(s>0)){ markInvalid(sEl); ok=false; }
    const vals = {};
    fields.forEach(el=>{ const raw=el.value.trim(); if(raw===''){ markInvalid(el); ok=false; } vals[el.id]=parseNumEl(el); });
    const rem = remPct(vals.protein, vals.fat, vals.fiber, vals.moisture, vals.ash);
    updateRemaining();
    if(!ok || rem<=0){ return; }

    const kcal100 = (vals.protein*3.5) + (rem*3.5) + (vals.fat*8.5);
    const kcalServing = kcal100*(s/100);

    document.getElementById('calServing').innerHTML = fmt(kcalServing) + ' <span class="unit">kcal</span>';
    document.getElementById('gProtein').innerHTML   = fmt(byPct(s, vals.protein)) + ' <span class="unit">g</span>';
    document.getElementById('gNfe').innerHTML       = fmt(byPct(s, rem))          + ' <span class="unit">g</span>';
    document.getElementById('gFat').innerHTML       = fmt(byPct(s, vals.fat))     + ' <span class="unit">g</span>';
    document.getElementById('gFiber').innerHTML     = fmt(byPct(s, vals.fiber))   + ' <span class="unit">g</span>';
    document.getElementById('gMoisture').innerHTML  = fmt(byPct(s, vals.moisture))+ ' <span class="unit">g</span>';
    document.getElementById('gAsh').innerHTML       = fmt(byPct(s, vals.ash))     + ' <span class="unit">g</span>';
  };

  window.resetAll = function(){
    sEl.value='';
    fields.forEach(el=>{el.value=''; el.classList.remove('invalid');});
    ['calServing','gProtein','gNfe','gFat','gFiber','gMoisture','gAsh'].forEach(id=>{ const el=document.getElementById(id); if(el) el.textContent='—'; });
    const pill=document.getElementById('remain'); if(pill){ pill.textContent='100%'; pill.classList.remove('bad'); }
    const tip=document.getElementById('remainTip'); if(tip){ tip.classList.remove('show'); }
  };

  // Bind live update
  document.addEventListener('DOMContentLoaded', ()=>{
    fields.forEach(el=>{ el.addEventListener('input', updateRemaining); el.addEventListener('change', updateRemaining); });
    updateRemaining();
  });
})();

// --- Enhanced remaining/alerts/validation ---
(function(){
  const $ = (s)=>document.querySelector(s);
  const byId = (id)=>document.getElementById(id);
  const fields = ['protein','fat','fiber','moisture','ash'].map(id=>byId(id));
  const sEl = byId('servingTop');
  function totalRem(){
    const v = Object.fromEntries(fields.map(el=>[el.id, parseNumEl(el)]));
    return 100 - ((v.protein||0)+(v.fat||0)+(v.fiber||0)+(v.moisture||0)+(v.ash||0));
  }
  window.updateRemaining = function(){
    const rem = totalRem();
    const pill = byId('remain');
    if(pill){ pill.textContent = (isFinite(rem)?Math.max(rem,-999):100).toFixed(0) + '%'; pill.classList.toggle('bad', rem<=0); }
    const area = byId('alertArea');
    if(area){
      if(rem<=0){
        area.style.display='block';
        area.textContent = (document.documentElement.lang==='ar') ? 'مجموع النِّسَب لازم يكون أقل من 100%' : 'Total of percentages must be less than 100%';
      }else{
        area.style.display='none'; area.textContent='';
      }
    }
  };
  // mark invalid helper
  function markInvalid(el){ if(!el) return; el.classList.add('invalid'); el.addEventListener('focus', ()=>el.classList.remove('invalid'), {once:true}); }
  // Hook calculate button if exists
  const calcBtn = byId('calc');
  if(calcBtn){
    calcBtn.addEventListener('click', (e)=>{
      // validate serving and fields; no alerts, just marks
      let ok = true;
      if(!(parseNumEl(sEl)>0)){ markInvalid(sEl); ok=false; }
      fields.forEach(el=>{ if(String(el.value).trim()===''){ markInvalid(el); ok=false; } });
      updateRemaining();
      if(!ok || totalRem()<=0){ e.preventDefault(); return; }
    });
  }
  // Live update on input/change
  fields.concat([sEl]).forEach(el=>{ if(el){ el.addEventListener('input', updateRemaining); el.addEventListener('change', updateRemaining);} });
  updateRemaining();
})();

// ---- precise validation & units, lang-aware ----
(function(){
  const $ = s=>document.querySelector(s);
  const byId = id=>document.getElementById(id);
  const fields = ['protein','fat','fiber','moisture','ash'].map(id=>byId(id));
  const sEl = byId('servingTop');
  function t(langKeyAr, langKeyEn){ return (document.documentElement.lang==='ar')?langKeyAr:langKeyEn; }

  function normalizeDigits(str){
    if(!str) return '';
    const map={'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9','۰':'0','۱':'1','۲':'2','۳':'3','۴':'4','۵':'5','۶':'6','۷':'7','۸':'8','۹':'9'};
    return String(str).replace(/[٠-٩۰-۹]/g, d=>map[d]).replace(/\u066B/g,'.').replace(/,/g,'.').trim();
  }
  window.parseNumEl = function(el){
    const v = normalizeDigits(el.value);
    const n = parseFloat(v);
    return (isFinite(n)?n:0);
  }

  function sumPerc(){
    let total=0;
    fields.forEach(el=>{ total += parseNumEl(el)||0; });
    return total;
  }

  function updateRemaining(){
    const rem = 100 - sumPerc();
    const pill = byId('remain');
    if(pill){ pill.textContent = (isFinite(rem)?Math.max(rem,-999):100).toFixed(0) + '%'; pill.classList.toggle('bad', rem<=0); }
    const area = byId('alertArea');
    if(area){
      if(rem<=0){
        area.style.display='block';
        area.textContent = t('مجموع النِّسَب لازم يكون أقل أو يساوي 100%','Total of percentages must be ≤ 100%');
      }else{
        area.style.display='none'; area.textContent='';
      }
    }
  }

  function markInvalid(el){ el.classList.add('invalid'); el.addEventListener('focus',()=>el.classList.remove('invalid'), {once:true}); }

  function validateAll(showMissingOnly=false){
    let ok = true;
    // serving > 0
    if(!(parseNumEl(sEl)>0)){ ok=false; if(!showMissingOnly) markInvalid(sEl); }
    // field rules
    fields.forEach(el=>{
      const vStr = normalizeDigits(el.value);
      const empty = vStr==='';
      const v = parseFloat(vStr);
      const outOfRange = isFinite(v) && (v<0 || v>100);
      if(empty || outOfRange){ ok=false; if(!showMissingOnly || outOfRange) markInvalid(el); }
    });
    return ok;
  }

  // attach live validation
  fields.concat([sEl]).forEach(el=>{
    if(!el) return;
    el.addEventListener('input', ()=>{ 
      updateRemaining();
      // Mark out-of-range immediately
      const v = parseNumEl(el);
      if(el!==sEl && (normalizeDigits(el.value)==='' || v<0 || v>100)){ el.classList.add('invalid'); }
      else { el.classList.remove('invalid'); }
    });
    el.addEventListener('change', updateRemaining);
  });

  // calculate button guard
  const calcBtn = byId('calc');
  if(calcBtn){
    calcBtn.addEventListener('click', (e)=>{
      updateRemaining();
      if(!validateAll()){ e.preventDefault(); return; }
      // proceed to compute & show units
      const s = parseNumEl(sEl);
      const vals = Object.fromEntries(fields.map(el=>[el.id, parseNumEl(el)]));
      const rem = 100 - (vals.protein+vals.fat+vals.fiber+vals.moisture+vals.ash);
      // Modified Atwater
      const kcal100 = (vals.protein*3.5) + (rem*3.5) + (vals.fat*8.5);
      const kcalServing = kcal100*(s/100);
      const byPct = (p)=> s*(p/100);
      function set(id, val, unit){ const el=byId(id); if(el) el.innerHTML = (isFinite(val)?val.toFixed(1):'—') + (unit?` <span class="unit">${unit}</span>`:''); }
      set('calServing', kcalServing, 'kcal');
      set('gProtein', byPct(vals.protein), 'g');
      set('gNfe',     byPct(rem),          'g');
      set('gFat',     byPct(vals.fat),     'g');
      set('gFiber',   byPct(vals.fiber),   'g');
      set('gMoisture',byPct(vals.moisture),'g');
      set('gAsh',     byPct(vals.ash),     'g');
    });
  }

  // init
  document.addEventListener('DOMContentLoaded', ()=>{
    updateRemaining();
  });
})();
</script>
</body>
</html>
